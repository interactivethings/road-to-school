<!DOCTYPE html>
<meta charset="utf-8">
<style>
body { 
  margin: 0; 
}
svg 
{
  position: absolute;
  top: 0;
  left: 0;
}
button {
  margin: 10px;
}
</style>
<body>
  <button id="A">behaviour A: vertical movement</button>
  <button id="B">behaviour B: school vs no school</button>
  <button id="C">behaviour C: change text</button>
  <button id="D">behaviour D: horizontal movement</button>
  <button id="E">behaviour E: move upwards</button>
  <div style="position: relative">
    <div id="canvas"></div>
    <div id="svg"></div>
  </div>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="fn.js"></script>
  <script>


  /* Configuration
  ----------------------------------------------- */
  var config = { 
    n: 1000, 
    width: 1080, 
    height: 500, 
    algoMap: [ 
      {
        id: "A",
        algo: function(state) { 
                var sim = d3.forceSimulation(state.data)
                  .alphaTarget(0.9)
                  .velocityDecay(0.5)
                  .force("Y", d3.forceY().strength(-0.01))
                  .stop();
                sim.tick();
                return state;
              }
      },
      {
        id: "B",
        algo: function(state) {
                state.data.filter(function(d) {
                    return d.moredata.type === 0;
                  })
                  .map(function(d){
                    d.moredata.color = 'red';
                  })
                return state;
              }
      },
      {
        id: "C",
        algo: function(state) {
          state.data.filter(function(d,i) {
            return i === Math.floor(Math.random() * state.data.length);
          })
          .map(function(d) {
            d3.select("text").text(d.moredata.text)
          })
          return state;
        }
      },
      {
        id: "D",
        algo: function(state) {
          var sim = d3.forceSimulation(state.data)
                  .alphaTarget(0.9)
                  .velocityDecay(0.5)
                  .force("X", d3.forceX().strength(0.01))
                  .stop();
                sim.tick();
                return state;
        }
      },
      {
        id: "E",
        algo: function(state) {
          var sim = d3.forceSimulation(state.data)
                  .alphaTarget(0.9)
                  .velocityDecay(0.5)
                  .force("Y", d3.forceY().strength(0.01))
                  .stop();
                sim.tick();
                return state;
        }
      }
    ]
  };
  var canvas = d3.select('#canvas')
    .append('canvas')
    .attr('width', config.width)
    .attr('height', config.height)
    .node().getContext('2d');

  var svg = d3.select('#svg')
    .append('svg')
    .attr('width', config.width )
    .attr('height', config.height + 100)
    .append('g');

  svg.append("text")
    .style("fill", "black")
    .style("font-family", "Helvetica Neue")
    .style("font-weight", "300")
    .style("font-size", "30")
    .style("text-anchor", "middle")
    .text("here's some text that should repel stuff" )
    .attr("x", config.width/2)
    .attr("y", config.height - 100);

  /* State initialization
  ----------------------------------------------- */
  var makeInitialState = function(config) {
      var state = {
        data: d3.range(config.n).map(function() 
              {
                return { 
                  x: config.width * Math.random(), 
                  y: config.height/2*Math.random(),
                  vx: 0,
                  vy: 0,
                  moredata: {
                    type: Math.floor(Math.random() + 0.5),  /* 1: school, 0: no school */
                    text: "story of a student!",
                    age: 0,
                    country: "Syria",
                    color: '#3B6C73'
                  }
                }
              }),
        timeSinceStart: 0,
        width: config.width,
        height: config.height,
        selectedAlgorithm: fn.identity,
        collisions: fn.identity
      };
      return state;
  };
  

  /* Render
  ----------------------------------------------- */
  function render(state, canvas, svg, actions) {

    // --------------------------------Define the actions

    d3.selectAll("button").on('click', function() { /* onSelectAlgorithm */

      config.algoMap.filter(function(algo) {
        return algo.id === d3.event.target.id;
      })
      .map(function(d) {
        actions.onSelectAlgorithm(function() {
          state.selectedAlgorithm = d.algo;
        });
      })
      
    });

    actions.avoidCollisions(function() {  /* prevent collission*/
      var box = d3.select("text").node().getBBox();
      state.data.filter(function(d) {
        return d.y > box.y;
      })
      .filter(function(d) {
        return d.x > box.x;
      })
      .filter(function(d) {
        return d.x < box.x + box.width
      })
      .map(function(d){
        d.fy = d.y; 
        d.fx = d.x;
      })
    });

    // --------------------------------Apply the actions

    state.selectedAlgorithm(state);   /* selectedAlgorithm */
    state.collisions(state); /* collisions */ 

    // --------------------------------Draw the canvas
    canvas.clearRect(0, 0, state.width, state.height); 
    for (var i = 0, node; i < state.data.length; ++i) {
      node = state.data[i];
      canvas.beginPath();
      canvas.arc(node.x,node.y, 3, 0, 2*Math.PI);
      canvas.fillStyle = node.moredata.color;
      canvas.fill();
    }
  }

  // Main loop
  (function (state, time, canvas, svg, config) {

    var actions = {
        onSelectAlgorithm: function(selectedAlgorithm) {
          state.selectedAlgorithm = selectedAlgorithm;
        },

        avoidCollisions: function(collisions) {
          state.collisions = collisions;
        }
      };

    function main() {
      ++time; 
      render(state, canvas, svg, actions);
    };

    d3.interval(main, 10);
  })(makeInitialState(config), 0, canvas, svg, config);

  </script>
</body>