<!DOCTYPE html>
<meta charset="utf-8">
<style>
body { 
  margin: 0; 
}
svg 
{
  position: absolute;
  top: 0;
  left: 0;
}
button {
  margin: 10px;
}
</style>
<body>
  <button id="vertical">behaviour A: vertical movement</button>
  <div style="position: relative">
    <div id="canvas"></div>
    <div id="svg"></div>
  </div>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="fn.js"></script>
  <script src="perlin.js"></script>
  <script>


  /* Configuration
  ----------------------------------------------- */
  var config = { 
    n: 2000, 
    width: 1080, 
    height: 500, 
    res: 0.2,
    behaviours: [ 
      {
        id: "vertical",
        behaviour: function(state) { 
                var sim = d3.forceSimulation(state.allData) // vertical force applied only to the dots
                  .alphaTarget(0.8)
                  .force("Y", d3.forceY().strength(function(d){  
                    return d.static ? 0.0001 : -0.01; // ----------------------------------------------- Dots move downwards, cicle slighly upwards to counteract the eventual displacement
                  }))
                  .stop();
                sim.tick();
                return state;
              }
      },
      {
        id: "baseline",
        behaviour: function(state) {
          state.data.forEach(function(d,i){
            var jitter = noise.perlin2(d.x, d.y);
            d.x = d.x + jitter * Math.random() * 5;
            d.y = d.y + jitter * Math.random() * 5;
          })
          var sim = d3.forceSimulation(state.allData)
                  .force(
                    "collide", 
                    d3.forceCollide()
                      .strength(0.8)
                      .radius(d => d.r)
                  )
                  .stop();
                sim.tick();
                return state;
        }
      }
    ]
  };

  var canvas = d3.select('#canvas')
    .append('canvas')
    .attr('width', config.width)
    .attr('height', config.height)
    .node().getContext('2d');

  var svg = d3.select('#svg')
    .append('svg')
    .attr('width', config.width)
    .attr('height', config.height + 100)
    .append('g');

  var circleDatum = {
    x: config.width/2,
    y: config.height - 100,
    r: 100,
    static: true
  };

  var circle = svg.append('circle')
    .style("stroke", "red")
    .style("fill", "transparent")
    .attr('r', circleDatum.r);

  var text = svg.append("text")
    .style("fill", "black")
    .style("font-family", "Helvetica Neue")
    .style("font-weight", "300")
    .style("font-size", "30")
    .style("text-anchor", "middle")
    .text("go away!" );

  var updateCircle = function() {
    circle
      .attr('cx', circleDatum.x)
      .attr('cy', circleDatum.y);
    text
      .attr('x', circleDatum.x)
      .attr('y', circleDatum.y);
  }


  /* State initialization
  ----------------------------------------------- */
  var makeInitialState = function(config) {
    updateCircle();
    var state = {
      data: d3.range(config.n).map(function() 
            {
              return { 
                x: config.width * Math.random(), 
                y: config.height/2*Math.random(),
                vx: 0,
                vy: 0,
                r: 3,
                moredata: {
                  type: Math.floor(Math.random() + 0.5),  /* 1: school, 0: no school */
                  text: "story of a student!",
                  age: 0,
                  country: "Syria",
                  color: '#3B6C73'
                }
              }
            }),
      width: config.width,
      height: config.height,
      selectedBehaviour: fn.identity
    };
    state.allData = [circleDatum].concat(state.data); // create an object with the dots and the obstacles
    return state;
  };
  

  /* Render
  ----------------------------------------------- */
  function render(state, canvas, svg, actions) {

   
    state = state.selectedBehaviour(state, {dom: null, svg: svg, canvas: canvas});  // ----------------------------------------------- Applied behaviours
    
    var collideBehaviour = fn.find(function(behav){ return behav.id === "baseline"; }, config.behaviours); // ------------------------------- Collision prevention behaviour
    collideBehaviour.behaviour(state);
    updateCircle();
    
    canvas.clearRect(0, 0, state.width, state.height);  // ----------------------------------------------- Draw the canvas
    for (var i = 0, node; i < state.data.length; ++i) {
      node = state.data[i];
      canvas.beginPath();
      canvas.arc(node.x,node.y, 3, 0, 2*Math.PI);
      canvas.fillStyle = node.moredata.color;
      canvas.fill();
    }

    // ----------------------------------------------- Events
    d3.selectAll("button").on('click', function() {
      actions.onSelectBehaviour(d3.event.target.id);
    });
  }

  /* Main loop
  ----------------------------------------------- */
  (function (state, time, canvas, svg, config) {

    var actions = {
        onSelectBehaviour: function(selectedId) {
          var maybeBehaviour = fn.find(function(behav){ return behav.id === selectedId; }, config.behaviours); //------------------ Find behaviour from config
          state.selectedBehaviour = maybeBehaviour.behaviour ? maybeBehaviour.behaviour : fn.identity; //------------------ Apply detected behaviour
        }
      };

    function main() {
      ++time; /*not using this right now*/ 
      render(state, canvas, svg, actions);
    };
    d3.interval(main, 10);
  })(makeInitialState(config), 0, canvas, svg, config);

  </script>
</body>